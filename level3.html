<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Level 3 - DOM XSS</title>
<style>
body {
  background: #0d0d0d;
  color: #00ff6a;
  font-family: Consolas;
  text-align: center;
  padding-top: 60px;
}
input, button {
  padding: 8px;
  background: #111;
  border: 1px solid #00ff6a;
  color: #00ff6a;
}
button {
  cursor: pointer;
  font-weight: bold;
}
.box {
  width: 60%;
  min-width: 300px;
  display: inline-block;
  background: #111;
  border: 1px solid #00ff6a;
  padding: 20px;
  border-radius: 6px;
}
.hint {
  margin-top: 10px;
  opacity: 0.8;
}
</style>
</head>
<body>

<h1>Level 3 - DOM XSS</h1>

<div class="box">
<p><b>Riddle:</b> A secret snack the browser keeps,<br>
In tiny jars while you donâ€™t peek.<br>
Ask politely and you may see,<br>
The final flag that waits for thee.</p><br>

<form>
  <input type="text" name="q" placeholder="Try something...">
  <button type="submit">Run</button>
</form>

<div id="output" style="margin-top:20px;"></div>
<p id="hint" class="hint"></p>
</div>

<script>
document.cookie = "session=CTF123; path=/;";

const flag = atob("WlNGTEFHe1kwVV9BcmVfIWhlX0JFU1R9");

function buildPayload() {
  const a = [60,115,99,114,105,112,116,62]; 
  const b = [97,108,101,114,116,40]; 
  const c = [100,111,99,117,109,101,110,116,46,99,111,111,107,105,101]; 
  const d = [41,41]; 
  const e = [60,47,115,99,114,105,112,116,62];
  return (
    a.map(x=>String.fromCharCode(x)).join("") +
    b.map(x=>String.fromCharCode(x)).join("") +
    c.map(x=>String.fromCharCode(x)).join("") +
    d.map(x=>String.fromCharCode(x)).join("") +
    e.map(x=>String.fromCharCode(x)).join("")
  );
}

let fails = parseInt(localStorage.getItem("lvl3fails") || "0");

const p = new URLSearchParams(location.search);
const q = p.get("q");

if (q) {
  document.getElementById("output").innerText = q;
  const required = buildPayload();

  if (q === required) {
    localStorage.removeItem("lvl3fails");
    const s = document.createElement("script");
    s.innerHTML = q.substring(8, q.length - 9); 
    document.body.appendChild(s);

    setTimeout(() => alert(flag), 800);
  } else {
    fails++;
    localStorage.setItem("lvl3fails", fails.toString());
  }
}
if (fails >= 3) {
  document.getElementById("hint").innerText = 'HINT: Read what the browser stores... then make it speak.';
}
</script>

</body>
</html>
